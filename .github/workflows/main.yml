name: Run My Bot Forever

on:
  workflow_dispatch: # ููุชุดุบูู ุงููุฏูู ุจุถุบุทุฉ ุฒุฑ
  schedule:
    - cron: '0 */6 * * *' # ุชุดุบูู ุชููุงุฆู ูู 6 ุณุงุนุงุช ูุงุญุชูุงุท

permissions:
  actions: write # ููุญ ุตูุงุญูุฉ ููุณูุฑูุฑ ููุชุญ ุฌูุณุงุช ุฌุฏูุฏุฉ ุชููุงุฆูุงู

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ุณุญุจ ุงูููุฏ ูู ุงููุณุชูุฏุน
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. ุฅุนุฏุงุฏ ุจูุฆุฉ ุจุงูุซูู
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. ุชุซุจูุช ุงููุชุทูุจุงุช (ูุชุตูุญ ูุฑููุ ุชูุฑุ ููุญุงูู ุงูุดุงุดุฉ)
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable tor xvfb
          pip install selenium requests

      # 4. ุฅุนุฏุงุฏ Tor ุจุดูู ุงุญุชุฑุงูู ูุถูุงู ูุชุญ ุงูู ControlPort
      - name: Configure and Start Tor
        run: |
          sudo service tor stop || true
          # ุฅุนุฏุงุฏ ููู torrc ููุณูุงุญ ุจุชุบููุฑ ุงูู IP ุจุฑูุฌูุงู
          sudo bash -c 'echo -e "ControlPort 9051\nCookieAuthentication 0\nDataDirectory /var/lib/tor" > /etc/tor/torrc'
          sudo service tor start
          echo "โณ Waiting for Tor to be ready..."
          sleep 20 # ููุช ุฅุถุงูู ูุถูุงู ุนูู ุชูุฑ ุจูุณุจุฉ 100%

      # 5. ุชุดุบูู ุงูุจูุช ูุน ุธููุฑ ุงูุณุฌู (Log) ููุฑุงู
      - name: Start Bot
        run: |
          # ูุณุชุฎุฏู -u ูุธููุฑ ุงูุณุฌู ููุฑุงู ู timeout ูุฅุบูุงูู ูุจู ุญุฏ ุงูู 6 ุณุงุนุงุช ููุนูุฏ ุชุดุบูู ููุณู
          # ุชุฃูุฏ ุฃู ุงุณู ูููู ูู bot_master2.py (ุฃู ุนุฏูู ููุง ุฅุฐุง ูุงู ูุฎุชููุงู)
          timeout 350m xvfb-run python -u bot_master2.py || echo "โ๏ธ ุงูุชูุช ุงูุฌูุณุฉ ุงูุญุงููุฉุ ุฌุงุฑู ุงูุงูุชูุงู ููุฌูุณุฉ ุงูุชุงููุฉ..."

      # 6. ุฅุนุงุฏุฉ ุงูุชุดุบูู ุงูุฐุงุชู (ุงูุณุฑ ูู ุงูู 12 ุณุงุนุฉ)
      - name: Self-Restart Workflow
        if: always() # ูุนูู ูู ูู ุงูุญุงูุงุช (ูุฌุงุญ ุฃู ูุดู) ูุถูุงู ุงูุงุณุชูุฑุงุฑูุฉ
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "๐ ุฌุงุฑู ุชุดุบูู ุฌูุณุฉ ุฌุฏูุฏุฉ ูุถูุงู ุงูุงุณุชูุฑุงุฑ ุฏูู ุชููู..."
          gh workflow run "Run My Bot Forever"
