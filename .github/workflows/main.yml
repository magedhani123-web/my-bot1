name: Run My Bot Forever

on:
  workflow_dispatch: # ุชุดุบูู ูุฏูู
  schedule:
    - cron: '0 */6 * * *' # ุชุดุบูู ุชููุงุฆู ูู 6 ุณุงุนุงุช ูุงุญุชูุงุท

permissions:
  actions: write # ุถุฑูุฑู ุฌุฏุงู ููุชููู ุงูุจูุช ูู ุฅุนุงุฏุฉ ุชุดุบูู ููุณู

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1" # ูุถูุงู ุธููุฑ ุงููุชุงุฆุฌ (Print) ููุฑุงู ูู ุงูุณุฌู

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Maximize System Resources (RAM Boost)
        # ูุฐุง ุงูุฌุฒุก ูุญุฑุฑ ูุณุงุญุฉ ููุฎูู ุฐุงูุฑุฉ ุงูุชุฑุงุถูุฉ (Swap) ุชุตู ูู 12 ุฌูุฌุง
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost /usr/local/lib/android
          sudo fallocate -l 12G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo sysctl vm.swappiness=10
          echo "๐ ุชู ุฒูุงุฏุฉ ุงูุฑุงู ุงูุงูุชุฑุงุถู ูุชุญุฑูุฑ ุงููุนุงูุฌ"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Google Chrome & System Dependencies
        run: |
          sudo apt-get update
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb
          # ุชุซุจูุช Tor ู ููุชุจุงุช ุงููุงุฌูุฉ ุงูุฑุณูููุฉ ูุงูุตูุช
          sudo apt-get install -y tor xvfb libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libasound2t64 ffmpeg

      - name: Install Python Packages
        run: |
          pip install undetected_chromedriver selenium requests

      - name: Configure and Start Tor
        run: |
          sudo service tor stop || true
          # ุฅุนุฏุงุฏ Tor ููุชุญ ูููุฐ ุงูุชุญูู (ControlPort) ูุชุจุฏูู ุงูู IP
          sudo bash -c 'echo -e "ControlPort 9051\nCookieAuthentication 0\nDataDirectory /var/lib/tor" > /etc/tor/torrc'
          sudo service tor start
          echo "โณ ุฌุงุฑู ุงูุชุธุงุฑ ุงุณุชูุฑุงุฑ ุงุชุตุงู Tor..."
          sleep 20

      - name: Start Bot (High Performance Mode)
        # ุงุณุชุฎุฏุงู xvfb-run ูุนูู ุดุงุดุฉ ููููุฉ + timeout ููุฅุบูุงู ูุจู ุญุฏ ุงูู 6 ุณุงุนุงุช
        run: |
          export DISPLAY=:99
          # timeout 350m ุชุนูู ุงูุนูู ููุฏุฉ 5 ุณุงุนุงุช ู 50 ุฏูููุฉ ุซู ุงูุฅุบูุงู ูุจุฏุก ุฏูุฑุฉ ุฌุฏูุฏุฉ
          timeout 350m xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24 -ac +extension GLX +render -noreset" python -u bot_master1.py || echo "โ๏ธ ุงูุชูุช ุงูุฏูุฑุฉ ุงูุญุงููุฉุ ุฌุงุฑู ุฅุนุงุฏุฉ ุงูุชุดุบูู..."

      - name: Self-Restart Workflow
        if: always() # ุฅุนุงุฏุฉ ุงูุชุดุบูู ุญุชู ูู ุญุฏุซ ุฎุทุฃ ูู ุงูุณูุฑุจุช
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "๐ ุจุฏุก ุนูููุฉ ุงูุชุดุบูู ุงูุฐุงุชู ููุฃุจุฏ..."
          gh workflow run "Run My Bot Forever"
